---
import EkouLogo from './icons/EkouLogo.jsx'
import ThemeController from './ThemeController.astro'
import MobileMenu from './MobileMenu.astro'
import {
  BookOpen,
  Briefcase,
  ChevronDown,
  CircleCheck,
  Handshake,
  House,
  Languages,
  Lightbulb,
  Menu,
  MessageCircle,
} from 'lucide-react'
import ModalLanguage from './ModalLanguage.astro'
import { getLangFromUrl, useTranslations } from '../i18n/utils/config'
const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)
const navbar = t('navbar')

const navLinks = [
  { href: '#main', label: navbar.home, icon: House },
  { href: '#quienes-somos', label: navbar.about, icon: Lightbulb },
  { href: '#como-te-ayudamos', label: navbar.help, icon: Handshake },
  { href: '#servicios', label: navbar.services, icon: Briefcase },
  { href: '#casos-de-exito', label: navbar.success, icon: CircleCheck },
  { href: '#equipo', label: navbar.team, icon: CircleCheck },
  { href: '#blog', label: navbar.blog, icon: BookOpen },
  { href: '#hablemos', label: navbar.contact, icon: MessageCircle },
]
---

<header class="flex w-full justify-center">
  <nav
    data-site-header
    class="w-[95%] md:w-[90%] min-w-[unset] lg:max-w-[85rem] h-14 m-auto bg-(--surface-secundary)/80 backdrop-blur-md text-(--text-primary) flex justify-between items-center px-6 rounded-3xl fixed z-50 top-6 border border-(--color-border)"
  >
    <EkouLogo />
    <div class="w-full flex justify-center">
      <ul class="hidden lg:flex flex-1 items-center justify-around w-full max-w-2xl">
        {
          navLinks.map(({ href, label }) => (
            <li>
              <a
                href={href}
                data-section-link={href}
                class="cursor-pointer text-sm transition-transform duration-100 ease-in-out hover:text-(--color-primary)"
              >
                {label}
              </a>
            </li>
          ))
        }
      </ul>
    </div>
    <div class="relative flex items-center gap-5 text-(--color-primary)">
      <div class="hidden lg:flex items-center">
        <ThemeController />
      </div>
      <button
        id="language-btn"
        aria-label={navbar.openLanguageModal}
        class="flex justify-center items-center cursor-pointer"
      >
        <Languages />
        <ChevronDown id="arrow" className="w-5 h-5 transition-transform duration-200" />
      </button>
      <!--menu hamburguesa -->
      <button
        id="mobile-menu-btn"
        class="lg:hidden cursor-pointer"
        aria-label="Open menu"
        aria-controls="mobile-menu"
        aria-expanded="false"
      >
        <Menu />
      </button>

      <section
        id="language-modal"
        class="lang-modal fixed right-2 top-16 z-50"
        aria-hidden="true"
        hidden
      >
        <ModalLanguage />
      </section>
    </div>
  </nav>
</header>

<MobileMenu navLinks={navLinks} />

<script>
  const btn = document.getElementById('language-btn')
  const modal = document.getElementById('language-modal')
  const arrow = document.getElementById('arrow')
  const menuBtn = document.getElementById('mobile-menu-btn')
  const mobileMenu = document.getElementById('mobile-menu')

  const closeLanguage = () => {
    modal?.classList.remove('open')
    arrow?.classList.remove('rotate-180')
    if (modal) {
      modal.setAttribute('aria-hidden', 'true')
      modal.setAttribute('hidden', '')
    }
  }

  const isMobileMenuOpen = () => mobileMenu?.classList.contains('open')

  const setMobileMenuState = (isOpen) => {
    if (!mobileMenu) return
    mobileMenu.classList.toggle('open', isOpen)
    mobileMenu.setAttribute('aria-hidden', String(!isOpen))
    if (menuBtn) menuBtn.setAttribute('aria-expanded', String(isOpen))
    if (isOpen) {
      mobileMenu.removeAttribute('hidden')
    } else {
      mobileMenu.setAttribute('hidden', '')
    }
  }

  const focusFirstMenuLink = () => {
    const firstLink = mobileMenu?.querySelector('a[href^="#"]')
    if (firstLink instanceof HTMLElement) {
      firstLink.focus({ preventScroll: true })
    }
  }

  const openMobileMenu = () => {
    if (!mobileMenu) return
    setMobileMenuState(true)
    requestAnimationFrame(focusFirstMenuLink)
  }

  const closeMobileMenu = ({ restoreFocus = true } = {}) => {
    if (!isMobileMenuOpen()) return
    setMobileMenuState(false)
    if (restoreFocus && menuBtn instanceof HTMLElement) {
      menuBtn.focus({ preventScroll: true })
    }
  }

  const getClosestLink = (event) => {
    if (typeof event.composedPath === 'function') {
      const path = event.composedPath()
      for (const node of path) {
        if (node?.nodeType === 1) {
          const link = node.closest('a[href^="#"]')
          if (link) return link
        }
      }
    }

    if (event.target?.nodeType === 1) {
      return event.target.closest('a[href^="#"]')
    }

    return null
  }

  if (btn && modal) {
    btn.addEventListener('click', (event) => {
      event.stopPropagation()
      const isOpen = modal.classList.toggle('open')
      arrow?.classList.toggle('rotate-180', isOpen)
      modal.setAttribute('aria-hidden', String(!isOpen))
      if (isOpen) {
        modal.removeAttribute('hidden')
      } else {
        modal.setAttribute('hidden', '')
      }
    })

    modal.addEventListener('click', (event) => event.stopPropagation())
  }

  if (menuBtn && mobileMenu) {
    menuBtn.addEventListener('click', (event) => {
      event.stopPropagation()
      if (isMobileMenuOpen()) {
        closeMobileMenu({ restoreFocus: true })
        return
      }
      openMobileMenu()
    })

    mobileMenu.addEventListener('click', (event) => {
      event.stopPropagation()
      const link = getClosestLink(event)
      if (!link) return
      closeMobileMenu({ restoreFocus: false })
    })
  }

  document.addEventListener('click', () => {
    closeLanguage()
    closeMobileMenu({ restoreFocus: true })
  })

  document.addEventListener('keydown', (event) => {
    if (event.key !== 'Escape') return
    closeLanguage()
    closeMobileMenu()
  })
</script>

<style>
  .lang-modal {
    opacity: 0;
    transform: translateY(-8px);
    pointer-events: none;
    transition:
      opacity 200ms ease,
      transform 200ms ease;
  }

  .lang-modal.open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  a.is-active {
    color: var(--color-primary);
  }

  #mobile-menu-btn:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 3px;
    border-radius: 9999px;
  }

  a[data-section-link] {
    position: relative;
  }

  a[data-section-link]::after {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    bottom: -3px;
    height: 1.5px;
    border-radius: 20px;
    background: currentColor;
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 220ms ease;
  }

  a[data-section-link].is-active::after {
    transform: scaleX(1);
  }
</style>
