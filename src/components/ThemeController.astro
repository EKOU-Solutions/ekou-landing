---
import { Moon, Sun } from 'lucide-react'

const { ariaLabel } = Astro.props
---

<button class="cursor-pointer theme-toggle is-dark" aria-label={ariaLabel} data-theme-toggle>
  <span class="theme-icon theme-icon--moon">
    <Sun />
  </span>
  <span class="theme-icon theme-icon--sun">
    <Moon />
  </span>
</button>

<script>
  ;(() => {
    if (typeof window === 'undefined') return

    const root = document.documentElement
    const storageKey = 'theme'

    const setTheme = (theme) => {
      root.dataset.theme = theme
      document.querySelectorAll('[data-theme-toggle]').forEach((btn) => {
        btn.classList.toggle('is-dark', theme === 'dark')
        btn.classList.toggle('is-light', theme === 'light')
      })
    }

    const initThemeToggles = () => {
      const buttons = Array.from(document.querySelectorAll('[data-theme-toggle]'))
      if (!buttons.length) return

      const storedTheme = localStorage.getItem(storageKey)
      setTheme(storedTheme || root.dataset.theme || 'dark')

      buttons.forEach((btn) => {
        if (btn.getAttribute('data-theme-toggle-bound') === 'true') return
        btn.setAttribute('data-theme-toggle-bound', 'true')
        btn.addEventListener('click', () => {
          const next = root.dataset.theme === 'light' ? 'dark' : 'light'
          setTheme(next)
          localStorage.setItem(storageKey, next)
        })
      })
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initThemeToggles, { once: true })
    } else {
      initThemeToggles()
    }
  })()
</script>

<style>
  .theme-toggle {
    position: relative;
    width: 32px;
    height: 32px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .theme-icon {
    position: absolute;
    opacity: 0;
    transition:
      opacity 200ms ease,
      transform 200ms ease;
  }

  .theme-icon--moon {
    transform: translateX(-10px);
  }

  .theme-icon--sun {
    transform: translateX(10px);
  }

  .theme-toggle.is-dark .theme-icon--moon,
  .theme-toggle.is-light .theme-icon--sun {
    opacity: 1;
    transform: translateX(0);
  }
</style>
